<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Insights</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Prop Types (Required for Recharts UMD) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- JSZip for ZIP extraction -->
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        linkedin: '#0A66C2',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass { background: rgba(31, 41, 55, 0.5); backdrop-filter: blur(10px); }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect } = React;

        // Data processing utilities
        const DataUtils = {
            // Parse various date formats from LinkedIn exports
            parseDate(dateStr) {
                if (!dateStr) return null;

                // Format: "25 Nov 2025" (Connections.csv)
                const dmyMatch = dateStr.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
                if (dmyMatch) {
                    return new Date(`${dmyMatch[2]} ${dmyMatch[1]}, ${dmyMatch[3]}`);
                }

                // Format: "2025-11-28 19:31:41 UTC" (messages.csv)
                const isoMatch = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
                if (isoMatch) {
                    return new Date(dateStr);
                }

                // Format: "Mon Oct 13 15:35:57 UTC 2025" (Company Follows.csv)
                const longMatch = dateStr.match(/\w{3}\s+(\w{3})\s+(\d{1,2})\s+[\d:]+\s+\w+\s+(\d{4})/);
                if (longMatch) {
                    return new Date(`${longMatch[1]} ${longMatch[2]}, ${longMatch[3]}`);
                }

                // Format: "10/19/22, 9:45 AM" (Saved Jobs.csv)
                const usMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{2})/);
                if (usMatch) {
                    const year = parseInt(usMatch[3]) + 2000;
                    return new Date(`${usMatch[1]}/${usMatch[2]}/${year}`);
                }

                return new Date(dateStr);
            },

            // Get unique message partners and last message date
            getMessagePartners(messages, userProfileUrl) {
                const partners = {};

                // Normalize URL for comparison
                const normalize = (url) => url ? url.trim().toLowerCase().replace(/\/$/, '') : '';
                const myUrl = normalize(userProfileUrl);

                messages.forEach(msg => {
                    const fromUrl = normalize(msg['SENDER PROFILE URL']);
                    // Some exports call it 'RECIPIENT PROFILE URLS', some 'TO'
                    // We need to be careful identifying the 'other' person

                    let partnerUrl, partnerName;

                    if (fromUrl === myUrl) {
                        // I sent it, so the partner is the recipient
                        partnerUrl = normalize(msg['RECIPIENT PROFILE URLS']);
                        partnerName = msg['TO'];
                    } else {
                        // Someone else sent it to me
                        partnerUrl = fromUrl;
                        partnerName = msg['FROM'];
                    }

                    if (!partnerUrl || partnerUrl === myUrl) return;

                    const date = this.parseDate(msg['DATE']);
                    if (!partners[partnerUrl] || date > partners[partnerUrl].lastMessage) {
                        partners[partnerUrl] = {
                            name: partnerName,
                            url: partnerUrl, // Store original (or normalized) logic handled later
                            lastMessage: date,
                            messageCount: (partners[partnerUrl]?.messageCount || 0) + 1
                        };
                    } else {
                        partners[partnerUrl].messageCount++;
                    }
                });

                return partners;
            },

            // Analyze network composition by company
            getNetworkComposition(connections) {
                const companies = {};
                const positions = {};

                connections.forEach(conn => {
                    const company = conn['Company'] || 'Unknown';
                    const position = conn['Position'] || 'Unknown';

                    companies[company] = (companies[company] || 0) + 1;
                    positions[position] = (positions[position] || 0) + 1;
                });

                return {
                    topCompanies: Object.entries(companies)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 15)
                        .map(([name, count]) => ({ name, count })),
                    topPositions: Object.entries(positions)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10)
                        .map(([name, count]) => ({ name, count }))
                };
            },

            // Get connection growth over time
            getConnectionGrowth(connections) {
                const monthly = {};

                connections.forEach(conn => {
                    const date = this.parseDate(conn['Connected On']);
                    if (!date || isNaN(date.getTime())) return;

                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthly[key] = (monthly[key] || 0) + 1;
                });

                // Calculate cumulative growth
                let cumulative = 0;
                return Object.entries(monthly)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([month, count]) => {
                        cumulative += count;
                        return { month, count: cumulative, new: count };
                    });
            },

            // Find dormant connections (time-based)
            getDormantConnections(connections, messagePartners, monthsThreshold = 12) {
                const now = new Date();
                const thresholdDate = new Date(now.setMonth(now.getMonth() - monthsThreshold));
                const normalize = (url) => url ? url.trim().toLowerCase().replace(/\/$/, '') : '';

                return connections
                    .map(conn => {
                        const connectedDate = this.parseDate(conn['Connected On']);
                        const url = normalize(conn['URL']);
                        const partner = messagePartners[url];

                        const lastContact = partner?.lastMessage || connectedDate;

                        // If we can't parse a connected date, ignore
                        if (!connectedDate) return null;

                        const monthsSinceContact = lastContact
                            ? Math.floor((new Date() - lastContact) / (1000 * 60 * 60 * 24 * 30))
                            : null;

                        return {
                            name: `${conn['First Name']} ${conn['Last Name']}`,
                            company: conn['Company'] || 'Unknown',
                            position: conn['Position'] || 'Unknown',
                            url: conn['URL'],
                            connectedOn: connectedDate,
                            lastMessage: partner?.lastMessage || null,
                            messageCount: partner?.messageCount || 0,
                            monthsSinceContact,
                            isDormant: !lastContact || lastContact < thresholdDate
                        };
                    })
                    .filter(c => c && c.isDormant)
                    .sort((a, b) => (b.connectedOn || 0) - (a.connectedOn || 0));
            },

            // Find strategic connections (at companies you follow or saved jobs for)
            getStrategicConnections(connections, companyFollows, savedJobs, messagePartners) {
                const targetCompanies = new Set();
                const normalize = (url) => url ? url.trim().toLowerCase().replace(/\/$/, '') : '';

                // Add followed companies
                companyFollows?.forEach(f => {
                    if (f['Organization']) targetCompanies.add(f['Organization'].toLowerCase());
                });

                // Add companies from saved jobs
                savedJobs?.forEach(j => {
                    if (j['Company Name']) targetCompanies.add(j['Company Name'].toLowerCase());
                });

                return connections
                    .filter(conn => {
                        const company = (conn['Company'] || '').toLowerCase();
                        return targetCompanies.has(company);
                    })
                    .map(conn => {
                        const url = normalize(conn['URL']);
                        const partner = messagePartners[url];

                        return {
                            name: `${conn['First Name']} ${conn['Last Name']}`,
                            company: conn['Company'],
                            position: conn['Position'] || 'Unknown',
                            url: conn['URL'],
                            lastMessage: partner?.lastMessage || null,
                            messageCount: partner?.messageCount || 0,
                            isWarm: partner && partner.messageCount > 0
                        };
                    })
                    .sort((a, b) => (b.messageCount || 0) - (a.messageCount || 0));
            },

            // Analyze career trajectory from positions
            getCareerTrajectory(positions) {
                return positions
                    .filter(p => p['Company Name'] && p['Started On'])
                    .map(p => {
                        const startParts = p['Started On'].split(' ');
                        const endParts = p['Finished On'] ? p['Finished On'].split(' ') : null;

                        const monthMap = { Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
                                           Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11 };

                        const startDate = new Date(parseInt(startParts[1]) || 2020, monthMap[startParts[0]] || 0);
                        const endDate = endParts
                            ? new Date(parseInt(endParts[1]) || 2024, monthMap[endParts[0]] || 11)
                            : new Date();

                        const months = Math.max(1, Math.round((endDate - startDate) / (1000 * 60 * 60 * 24 * 30)));

                        return {
                            company: p['Company Name'],
                            title: p['Title'],
                            description: p['Description'],
                            location: p['Location'],
                            startDate,
                            endDate: endParts ? endDate : null,
                            isCurrent: !endParts,
                            tenureMonths: months
                        };
                    })
                    .sort((a, b) => b.startDate - a.startDate);
            }
        };

        const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, LineChart, Line, PieChart, Pie, Cell, AreaChart, Area } = Recharts;

        const COLORS = ['#0A66C2', '#00A0DC', '#86D4F5', '#0073B1', '#004182', '#7FC15E', '#E68523', '#DD5143'];

        function StatCard({ label, value, subtitle }) {
            return (
                <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <p className="text-gray-400 text-sm mb-1 uppercase tracking-wider">{label}</p>
                    <p className="text-3xl font-bold text-white">{value}</p>
                    {subtitle && <p className="text-gray-500 text-sm mt-1">{subtitle}</p>}
                </div>
            );
        }

        function NetworkComposition({ data }) {
            return (
                <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <h3 className="text-xl font-semibold mb-4">Top Companies in Your Network</h3>
                    <ResponsiveContainer width="100%" height={300}>
                        <BarChart data={data.slice(0, 10)} layout="vertical" margin={{ left: 20 }}>
                            <XAxis type="number" stroke="#666" />
                            <YAxis type="category" dataKey="name" stroke="#9ca3af" width={150} tick={{ fontSize: 12 }} />
                            <Tooltip
                                contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151', borderRadius: '8px', color: '#fff' }}
                                labelStyle={{ color: '#e5e7eb' }}
                                cursor={{fill: 'rgba(255,255,255,0.05)'}}
                            />
                            <Bar dataKey="count" fill="#0A66C2" radius={[0, 4, 4, 0]} barSize={20} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            );
        }

        function ConnectionGrowth({ data }) {
            return (
                <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <h3 className="text-xl font-semibold mb-4">Connection Growth (Cumulative)</h3>
                    <ResponsiveContainer width="100%" height={300}>
                        <AreaChart data={data}>
                            <defs>
                                <linearGradient id="colorCount" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#0A66C2" stopOpacity={0.8}/>
                                    <stop offset="95%" stopColor="#0A66C2" stopOpacity={0}/>
                                </linearGradient>
                            </defs>
                            <XAxis dataKey="month" stroke="#666" tick={{ fontSize: 10 }} minTickGap={30} />
                            <YAxis stroke="#666" />
                            <Tooltip
                                contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151', borderRadius: '8px' }}
                                labelStyle={{ color: '#fff' }}
                            />
                            <Area type="monotone" dataKey="count" stroke="#0A66C2" fillOpacity={1} fill="url(#colorCount)" />
                        </AreaChart>
                    </ResponsiveContainer>
                </div>
            );
        }

        function DormantConnections({ connections }) {
            const [showAll, setShowAll] = useState(false);
            const displayed = showAll ? connections : connections.slice(0, 10);

            if (!connections || connections.length === 0) {
                return (
                     <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                        <h3 className="text-xl font-semibold">Dormant Connections</h3>
                        <p className="text-gray-400 mt-2">No dormant connections found. Either you are very active, or message history couldn't be linked.</p>
                     </div>
                )
            }

            return (
                <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <div className="flex justify-between items-center mb-4">
                        <div>
                            <h3 className="text-xl font-semibold">Dormant Connections</h3>
                            <p className="text-gray-400 text-sm">People you haven't messaged in 12+ months</p>
                        </div>
                        <span className="bg-yellow-600/30 text-yellow-400 px-3 py-1 rounded-full text-sm font-medium">
                            {connections.length} found
                        </span>
                    </div>

                    <div className="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                        {displayed.map((conn, i) => (
                            <div
                                key={i}
                                className="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition group"
                            >
                                <div className="overflow-hidden">
                                    <a href={conn.url} target="_blank" rel="noopener noreferrer" className="font-medium hover:text-linkedin truncate block">
                                        {conn.name}
                                    </a>
                                    <p className="text-sm text-gray-400 truncate">{conn.position} at {conn.company}</p>
                                </div>
                                <div className="text-right text-sm shrink-0 ml-4">
                                    <p className="text-gray-400">
                                        {conn.lastMessage
                                            ? `Last msg: ${conn.lastMessage.toLocaleDateString()}`
                                            : 'Never messaged'}
                                    </p>
                                    <p className="text-gray-500 text-xs">
                                        Conn: {conn.connectedOn?.toLocaleDateString() || 'Unknown'}
                                    </p>
                                </div>
                            </div>
                        ))}
                    </div>

                    {connections.length > 10 && (
                        <button
                            onClick={() => setShowAll(!showAll)}
                            className="mt-4 w-full py-2 text-linkedin hover:underline text-sm font-medium"
                        >
                            {showAll ? 'Show less' : `Show all ${connections.length} dormant connections`}
                        </button>
                    )}
                </div>
            );
        }

        function StrategicConnections({ connections }) {
            const [showAll, setShowAll] = useState(false);
            const warmConnections = connections.filter(c => c.isWarm);
            const coldConnections = connections.filter(c => !c.isWarm);
            const displayed = showAll ? connections : connections.slice(0, 10);

            if (!connections || connections.length === 0) {
                 return (
                     <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                        <h3 className="text-xl font-semibold">Strategic Connections</h3>
                        <p className="text-gray-400 mt-2">No strategic connections found. Try following more companies or saving jobs.</p>
                     </div>
                )
            }

            return (
                <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <div className="flex justify-between items-center mb-4">
                        <div>
                            <h3 className="text-xl font-semibold">Strategic Connections</h3>
                            <p className="text-gray-400 text-sm">People at companies you follow or saved jobs for</p>
                        </div>
                        <div className="flex gap-2">
                            <span className="bg-green-600/30 text-green-400 px-3 py-1 rounded-full text-sm font-medium">
                                {warmConnections.length} warm
                            </span>
                            <span className="bg-blue-600/30 text-blue-400 px-3 py-1 rounded-full text-sm font-medium">
                                {coldConnections.length} cold
                            </span>
                        </div>
                    </div>

                    <div className="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                        {displayed.map((conn, i) => (
                            <div
                                key={i}
                                className="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition"
                            >
                                <div className="flex items-center gap-3 overflow-hidden">
                                    <span className={`w-2 h-2 rounded-full shrink-0 ${conn.isWarm ? 'bg-green-400' : 'bg-blue-400'}`} />
                                    <div className="overflow-hidden">
                                        <a href={conn.url} target="_blank" rel="noopener noreferrer" className="font-medium hover:text-linkedin truncate block">
                                            {conn.name}
                                        </a>
                                        <p className="text-sm text-gray-400 truncate">{conn.position} at {conn.company}</p>
                                    </div>
                                </div>
                                <div className="text-right text-sm text-gray-400 shrink-0 ml-4">
                                    {conn.messageCount > 0
                                        ? `${conn.messageCount} msgs`
                                        : 'No msgs'}
                                </div>
                            </div>
                        ))}
                    </div>

                    {connections.length > 10 && (
                        <button
                            onClick={() => setShowAll(!showAll)}
                            className="mt-4 w-full py-2 text-linkedin hover:underline text-sm font-medium"
                        >
                            {showAll ? 'Show less' : `Show all ${connections.length} strategic connections`}
                        </button>
                    )}
                </div>
            );
        }

        function NetworkHealth({ data, insights }) {
            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold flex items-center gap-2">
                        <span>üîó</span> Network Health
                    </h2>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <StatCard
                            label="Total Connections"
                            value={data.connections?.length?.toLocaleString() || 0}
                        />
                        <StatCard
                            label="Companies in Network"
                            value={insights.composition.topCompanies.length}
                            subtitle="unique companies"
                        />
                        <StatCard
                            label="Dormant"
                            value={insights.dormant.length}
                            subtitle="12+ months silent"
                        />
                        <StatCard
                            label="Strategic"
                            value={insights.strategic.length}
                            subtitle="at target companies"
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <NetworkComposition data={insights.composition.topCompanies} />
                        <ConnectionGrowth data={insights.growth} />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <DormantConnections connections={insights.dormant} />
                        <StrategicConnections connections={insights.strategic} />
                    </div>
                </div>
            );
        }

        function CareerTimeline({ positions }) {
            const totalYears = positions.length > 0
                ? Math.ceil((new Date() - positions[positions.length - 1]?.startDate) / (1000 * 60 * 60 * 24 * 365))
                : 0;

            return (
                <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <h3 className="text-xl font-semibold mb-6">Career Timeline</h3>

                    <div className="relative">
                        {/* Timeline line */}
                        <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-600" />

                        <div className="space-y-6">
                            {positions.map((pos, i) => (
                                <div key={i} className="relative pl-12">
                                    {/* Timeline dot */}
                                    <div className={`absolute left-2.5 w-3 h-3 rounded-full border-2 border-gray-800 ${pos.isCurrent ? 'bg-green-400' : 'bg-linkedin'}`} />

                                    <div className="bg-gray-700/50 rounded-lg p-4 hover:bg-gray-700 transition">
                                        <div className="flex flex-col sm:flex-row justify-between items-start mb-2 gap-2">
                                            <div>
                                                <h4 className="font-semibold text-lg">{pos.title}</h4>
                                                <p className="text-linkedin font-medium">{pos.company}</p>
                                            </div>
                                            <div className="text-left sm:text-right text-sm shrink-0">
                                                <p className="text-gray-300">
                                                    {pos.startDate?.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
                                                    {' ‚Üí '}
                                                    {pos.isCurrent ? 'Present' : pos.endDate?.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
                                                </p>
                                                <p className="text-gray-500">
                                                    {Math.floor(pos.tenureMonths / 12)}y {pos.tenureMonths % 12}m
                                                </p>
                                            </div>
                                        </div>
                                        {pos.location && (
                                            <p className="text-sm text-gray-400 mt-1">üìç {pos.location}</p>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function TenureAnalysis({ positions }) {
            const tenures = positions.map(p => p.tenureMonths);
            const avgTenure = tenures.length > 0
                ? Math.round(tenures.reduce((a, b) => a + b, 0) / tenures.length)
                : 0;
            const maxTenure = Math.max(...tenures, 0);
            const minTenure = Math.min(...tenures.filter(t => t > 0), 0);

            const chartData = positions.map(p => ({
                name: p.company.length > 15 ? p.company.substring(0, 15) + '...' : p.company,
                fullCompany: p.company,
                months: p.tenureMonths,
                current: p.isCurrent
            })).reverse();

            return (
                <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <h3 className="text-xl font-semibold mb-4">Tenure Analysis</h3>

                    <div className="grid grid-cols-3 gap-4 mb-6">
                        <div className="text-center p-4 bg-gray-700/50 rounded-lg">
                            <p className="text-2xl font-bold text-white">
                                {Math.floor(avgTenure / 12)}y {avgTenure % 12}m
                            </p>
                            <p className="text-sm text-gray-400">Average Tenure</p>
                        </div>
                        <div className="text-center p-4 bg-gray-700/50 rounded-lg">
                            <p className="text-2xl font-bold text-green-400">
                                {Math.floor(maxTenure / 12)}y {maxTenure % 12}m
                            </p>
                            <p className="text-sm text-gray-400">Longest Role</p>
                        </div>
                        <div className="text-center p-4 bg-gray-700/50 rounded-lg">
                            <p className="text-2xl font-bold text-yellow-400">
                                {Math.floor(minTenure / 12)}y {minTenure % 12}m
                            </p>
                            <p className="text-sm text-gray-400">Shortest Role</p>
                        </div>
                    </div>

                    <ResponsiveContainer width="100%" height={250}>
                        <BarChart data={chartData}>
                            <XAxis dataKey="name" stroke="#666" tick={{ fontSize: 10 }} angle={-45} textAnchor="end" height={60} />
                            <YAxis stroke="#666" label={{ value: 'Months', angle: -90, position: 'insideLeft', fill: '#666' }} />
                            <Tooltip
                                contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151', borderRadius: '8px' }}
                                formatter={(value, name, props) => [`${Math.floor(value/12)}y ${value%12}m`, props.payload.fullCompany]}
                                labelStyle={{ display: 'none' }}
                            />
                            <Bar dataKey="months" fill="#0A66C2" radius={[4, 4, 0, 0]}>
                                {chartData.map((entry, index) => (
                                    <Cell key={index} fill={entry.current ? '#22c55e' : '#0A66C2'} />
                                ))}
                            </Bar>
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            );
        }

        function CareerInsights({ positions }) {
            // Calculate career stats
            const totalExperience = positions.reduce((sum, p) => sum + p.tenureMonths, 0);
            const uniqueCompanies = new Set(positions.map(p => p.company)).size;
            const currentRole = positions.find(p => p.isCurrent);

            // Detect career transitions
            const transitions = [];
            for (let i = 0; i < positions.length - 1; i++) {
                const current = positions[i];
                const prev = positions[i + 1];

                const getLevel = (title) => {
                    title = title?.toLowerCase() || '';
                    if (title.includes('founder') || title.includes('chief') || title.includes('vp') || title.includes('president')) return 'Executive';
                    if (title.includes('director') || title.includes('head')) return 'Director';
                    if (title.includes('manager') || title.includes('lead')) return 'Manager';
                    if (title.includes('senior') || title.includes('sr.')) return 'Senior IC';
                    return 'IC';
                };

                const currentLevel = getLevel(current.title);
                const prevLevel = getLevel(prev.title);

                if (currentLevel !== prevLevel) {
                    transitions.push({
                        from: prevLevel,
                        to: currentLevel,
                        year: current.startDate?.getFullYear(),
                        title: current.title
                    });
                }
            }

            return (
                <div className="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700">
                    <h3 className="text-xl font-semibold mb-4">Career Insights</h3>

                    <div className="space-y-4">
                        <div className="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                            <span className="text-gray-300">Total Experience</span>
                            <span className="font-semibold">{Math.floor(totalExperience / 12)} years {totalExperience % 12} months</span>
                        </div>

                        <div className="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                            <span className="text-gray-300">Companies Worked At</span>
                            <span className="font-semibold">{uniqueCompanies}</span>
                        </div>

                        <div className="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                            <span className="text-gray-300">Current Role</span>
                            <span className="font-semibold text-green-400">{currentRole?.title || 'N/A'}</span>
                        </div>

                        {transitions.length > 0 && (
                            <div className="mt-4">
                                <p className="text-gray-400 text-sm mb-3">Key Level Transitions</p>
                                <div className="flex flex-wrap gap-2">
                                    {transitions.slice(0, 5).map((t, i) => (
                                        <div key={i} className="bg-linkedin/20 border border-linkedin/30 px-3 py-2 rounded-lg text-sm w-full">
                                            <div className="flex justify-between text-linkedin font-medium">
                                                <span>{t.from} ‚Üí {t.to}</span>
                                                <span>{t.year}</span>
                                            </div>
                                            <div className="text-xs text-gray-400 mt-1">{t.title}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function CareerTrajectory({ data, insights }) {
            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold flex items-center gap-2">
                        <span>üìà</span> Career Trajectory
                    </h2>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <StatCard
                            label="Total Positions"
                            value={insights.trajectory.length}
                        />
                        <StatCard
                            label="Years in Career"
                            value={Math.floor(insights.trajectory.reduce((s, p) => s + p.tenureMonths, 0) / 12)}
                        />
                        <StatCard
                            label="Current Role"
                            value={insights.trajectory.find(p => p.isCurrent)?.title?.split(' ')[0] || 'N/A'}
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <CareerTimeline positions={insights.trajectory} />
                        <div className="space-y-6">
                            <TenureAnalysis positions={insights.trajectory} />
                            <CareerInsights positions={insights.trajectory} />
                        </div>
                    </div>
                </div>
            );
        }

        function Dashboard({ data, userProfileUrl }) {
            const [activeTab, setActiveTab] = useState('network');
            const [insights, setInsights] = useState(null);

            useEffect(() => {
                if(!data) return;

                // Compute all insights
                const messagePartners = DataUtils.getMessagePartners(data.messages || [], userProfileUrl);

                const calculated = {
                    composition: DataUtils.getNetworkComposition(data.connections || []),
                    growth: DataUtils.getConnectionGrowth(data.connections || []),
                    dormant: DataUtils.getDormantConnections(data.connections || [], messagePartners, 12),
                    strategic: DataUtils.getStrategicConnections(
                        data.connections || [],
                        data.companyFollows || [],
                        data.savedJobs || [],
                        messagePartners
                    ),
                    trajectory: DataUtils.getCareerTrajectory(data.positions || [])
                };
                setInsights(calculated);
            }, [data, userProfileUrl]);

            if (!insights) return <div className="text-center p-12">Analyzing data...</div>;

            return (
                <div className="max-w-7xl mx-auto fade-in">
                    {/* Tab Navigation */}
                    <div className="flex justify-center gap-4 mb-8">
                        <button
                            onClick={() => setActiveTab('network')}
                            className={`px-6 py-3 rounded-full font-medium transition ${
                                activeTab === 'network'
                                    ? 'bg-linkedin text-white shadow-lg shadow-blue-500/20'
                                    : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                            }`}
                        >
                            Network Health
                        </button>
                        <button
                            onClick={() => setActiveTab('career')}
                            className={`px-6 py-3 rounded-full font-medium transition ${
                                activeTab === 'career'
                                    ? 'bg-linkedin text-white shadow-lg shadow-blue-500/20'
                                    : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                            }`}
                        >
                            Career Trajectory
                        </button>
                    </div>

                    {/* Content */}
                    <div className="fade-in pb-12">
                        {activeTab === 'network' && <NetworkHealth data={data} insights={insights} />}
                        {activeTab === 'career' && <CareerTrajectory data={data} insights={insights} />}
                    </div>

                    {/* Footer */}
                    <footer className="mt-12 text-center text-gray-600 text-sm border-t border-gray-800 pt-8 pb-8">
                        <p>Your data never leaves your browser. Built with privacy in mind.</p>
                        <button
                            onClick={() => window.location.reload()}
                            className="mt-4 text-linkedin hover:underline"
                        >
                            Upload different data
                        </button>
                    </footer>
                </div>
            );
        }

        function Header() {
            return (
                <header className="text-center mb-12 fade-in pt-8">
                    <div className="inline-flex items-center gap-3 mb-4">
                        <div className="w-12 h-12 bg-linkedin rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30">
                            <span className="text-2xl">üìä</span>
                        </div>
                        <h1 className="text-4xl font-bold tracking-tight">LinkedIn Insights</h1>
                    </div>
                    <p className="text-gray-400 max-w-xl mx-auto text-lg">
                        Discover actionable insights from your professional network.
                        Find dormant connections and analyze your career path.
                    </p>
                </header>
            );
        }

        function FileUpload({ onDataLoaded }) {
            const [isDragging, setIsDragging] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [userUrl, setUserUrl] = useState('');

            const parseCSV = (text, skipLines = 0) => {
                return new Promise((resolve) => {
                    if (skipLines > 0) {
                        const lines = text.split('\n');
                        text = lines.slice(skipLines).join('\n');
                    }
                    Papa.parse(text, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => resolve(results.data)
                    });
                });
            };

            const processZip = async (file) => {
                if (!userUrl) {
                    setError('Please enter your LinkedIn Profile URL first');
                    return;
                }

                setLoading(true);
                setError(null);

                try {
                    const zip = await JSZip.loadAsync(file);
                    const data = {};

                    const fileMapping = {
                        'Connections.csv': { key: 'connections', skipLines: 3 },
                        'messages.csv': { key: 'messages', skipLines: 0 },
                        'Positions.csv': { key: 'positions', skipLines: 0 },
                        'Company Follows.csv': { key: 'companyFollows', skipLines: 0 },
                        'Skills.csv': { key: 'skills', skipLines: 0 },
                        'Education.csv': { key: 'education', skipLines: 0 },
                        'Jobs/Saved Jobs.csv': { key: 'savedJobs', skipLines: 0 },
                        'Jobs/Job Applications.csv': { key: 'jobApplications', skipLines: 0 },
                    };

                    for (const [fileName, config] of Object.entries(fileMapping)) {
                        const zipFile = zip.file(fileName);
                        if (zipFile) {
                            const text = await zipFile.async('string');
                            data[config.key] = await parseCSV(text, config.skipLines);
                        }
                    }

                    if (!data.connections || data.connections.length === 0) {
                        throw new Error('No connections found. Please upload a valid LinkedIn export ZIP.');
                    }

                    onDataLoaded(data, userUrl);
                } catch (err) {
                    console.error(err);
                    setError(err.message || 'Error processing file');
                } finally {
                    setLoading(false);
                }
            };

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.zip') || file.type === 'application/zip' || file.type === 'application/x-zip-compressed')) {
                    processZip(file);
                } else {
                    setError('Please upload a ZIP file');
                }
            }, [userUrl]);

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    processZip(file);
                }
            };

            return (
                <div className="max-w-2xl mx-auto space-y-6">
                     <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
                        <label className="block text-sm font-medium text-gray-300 mb-2">
                            1. Enter your LinkedIn Profile URL (Required for message analysis)
                        </label>
                        <input
                            type="text"
                            placeholder="https://www.linkedin.com/in/your-name"
                            value={userUrl}
                            onChange={(e) => setUserUrl(e.target.value)}
                            className="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-linkedin focus:border-transparent outline-none transition"
                        />
                        <p className="text-xs text-gray-500 mt-2">
                            This is needed to identify "You" in message threads so we can find who you talk to.
                        </p>
                    </div>

                    <div
                        onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                        onDragLeave={() => setIsDragging(false)}
                        onDrop={handleDrop}
                        className={`border-2 border-dashed rounded-2xl p-12 text-center transition-all cursor-pointer relative overflow-hidden
                            ${isDragging ? 'border-linkedin bg-linkedin/10 scale-[1.02]' : 'border-gray-600 hover:border-gray-500 hover:bg-gray-800/50'}
                            ${loading ? 'opacity-50 pointer-events-none' : ''}`}
                    >
                        <input
                            type="file"
                            accept=".zip"
                            onChange={handleFileSelect}
                            className="hidden"
                            id="file-input"
                            disabled={loading}
                        />
                        <label htmlFor="file-input" className="cursor-pointer block">
                            <div className={`text-6xl mb-4 transition-transform duration-700 ${loading ? 'animate-bounce' : ''}`}>
                                {loading ? '‚öôÔ∏è' : 'üìÇ'}
                            </div>
                            <h2 className="text-2xl font-semibold mb-2">
                                {loading ? 'Processing Data...' : '2. Drop your LinkedIn export ZIP here'}
                            </h2>
                            <p className="text-gray-400 mb-4">
                                or click to browse
                            </p>
                            <div className="inline-block px-4 py-1 bg-gray-700 rounded-full text-xs text-gray-300">
                                Privacy First: No data is uploaded to any server
                            </div>
                        </label>
                    </div>

                    {error && (
                        <div className="p-4 bg-red-900/30 border border-red-500/50 rounded-lg text-red-200 flex items-center gap-3 animate-pulse">
                            <span>‚ö†Ô∏è</span> {error}
                        </div>
                    )}

                    <details className="mt-8 text-left text-sm text-gray-500 bg-gray-800/50 p-4 rounded-lg">
                        <summary className="cursor-pointer hover:text-gray-300 font-medium">How to get your LinkedIn data export</summary>
                        <ol className="mt-3 ml-4 space-y-2 list-decimal text-gray-400">
                            <li>Go to <a href="https://www.linkedin.com/mypreferences/d/download-my-data" target="_blank" rel="noopener noreferrer" className="text-linkedin hover:underline">LinkedIn Data Export</a></li>
                            <li>Select "Want something in particular?" and check <strong>Connections</strong>, <strong>Messages</strong>, and <strong>Positions</strong> (or just "Select All").</li>
                            <li>Click "Request archive"</li>
                            <li>Wait for the email (can take 10 mins to 24 hours)</li>
                            <li>Download the ZIP and drop it above!</li>
                        </ol>
                    </details>
                </div>
            );
        }

        function App() {
            const [data, setData] = useState(null);
            const [userUrl, setUserUrl] = useState('');

            const handleDataLoaded = (loadedData, url) => {
                setData(loadedData);
                setUserUrl(url);
            };

            if (!data) {
                return (
                    <div className="min-h-screen p-4 md:p-8">
                        <Header />
                        <FileUpload onDataLoaded={handleDataLoaded} />
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="text-center mb-8 fade-in">
                        <div className="inline-block p-2 px-4 rounded-full bg-gray-800 border border-gray-700 text-sm text-gray-400 mb-4">
                            Analyzing <strong>{data.connections?.length?.toLocaleString() || 0}</strong> connections
                        </div>
                        <h1 className="text-4xl font-bold mb-2">LinkedIn Insights</h1>
                    </div>
                    <Dashboard data={data} userProfileUrl={userUrl} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>